<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>高校教員用 週案管理アプリ</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel (for JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Phosphor Icons (Lightweight icons) -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        /* Base Styles & Resets */
        body {
            /* UD Fonts Priority */
            font-family: 'BIZ UDPGothic', 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, 'Helvetica Neue', Arial, sans-serif;
            background-color: #f3f4f6;
            touch-action: manipulation; /* Improves touch response */
        }
        
        /* Disable pull-to-refresh on mobile to prevent accidental reloads */
        overscroll-behavior-y: contain;

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        ::-webkit-scrollbar-thumb {
            background: #c1c1c1; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8; 
        }

        /* Modal Animation */
        .modal-enter { opacity: 0; transform: scale(0.95); }
        .modal-enter-active { opacity: 1; transform: scale(1); transition: all 200ms ease-out; }
        .modal-exit { opacity: 1; transform: scale(1); }
        .modal-exit-active { opacity: 0; transform: scale(0.95); transition: all 200ms ease-in; }

        /* Grid Layout for Timetable */
        .timetable-grid {
            display: grid;
            grid-template-columns: 35px repeat(6, 1fr); /* Time + 6 Days (Mon-Sat) */
            gap: 2px;
            background-color: #e5e7eb; /* Grid lines color */
            border: 1px solid #e5e7eb;
        }
        .timetable-cell {
            background-color: white;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            font-size: 0.85rem;
            cursor: pointer;
            padding: 2px;
            transition: background-color 0.1s;
        }
        .timetable-cell:active {
            background-color: #f9fafb;
        }
        .timetable-header {
            background-color: #f9fafb;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 8px 0;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .period-header {
            background-color: #f9fafb;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6b7280;
            /* Larger font for period numbers */
            font-size: 1rem; 
        }

        @media (max-width: 640px) {
            .timetable-cell {
                font-size: 0.70rem;
                min-height: 70px;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- Utils ---
        
        // Date helpers
        const getMonday = (d) => {
            d = new Date(d);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            return new Date(d.setDate(diff));
        };

        const addDays = (date, days) => {
            const result = new Date(date);
            result.setDate(result.getDate() + days);
            return result;
        };

        const formatDateKey = (date) => {
            return date.toISOString().split('T')[0];
        };

        const formatDateJP = (date) => {
            return `${date.getFullYear()}年${date.getMonth() + 1}月${date.getDate()}日`;
        };
        
        const formatDateMMDD = (date) => {
            return `${date.getMonth() + 1}/${date.getDate()}`;
        };

        // Helper for Year-Month handling cross-month/year
        const getYearMonthString = (monday) => {
            const saturday = addDays(monday, 5);
            const startYear = monday.getFullYear();
            const startMonth = monday.getMonth() + 1;
            const endYear = saturday.getFullYear();
            const endMonth = saturday.getMonth() + 1;

            if (startYear === endYear && startMonth === endMonth) {
                return `${startYear}年${startMonth}月`;
            } else {
                return `${startYear}年${startMonth}月-${endYear}年${endMonth}月`;
            }
        };

        const getWeekRangeString = (monday) => {
            const saturday = addDays(monday, 5);
            return `${formatDateJP(monday)} 〜 ${formatDateJP(saturday)}`;
        };

        // --- Holiday Logic ---
        const getHolidayNameRaw = (date) => {
            const year = date.getFullYear();
            const month = date.getMonth() + 1;
            const day = date.getDate();
            const dayOfWeek = date.getDay();

            // Fixed Dates
            if (month === 1 && day === 1) return "元日";
            if (month === 2 && day === 11) return "建国記念の日";
            if (month === 2 && day === 23) return "天皇誕生日";
            if (month === 4 && day === 29) return "昭和の日";
            if (month === 5 && day === 3) return "憲法記念日";
            if (month === 5 && day === 4) return "みどりの日";
            if (month === 5 && day === 5) return "こどもの日";
            if (month === 8 && day === 11) return "山の日";
            if (month === 11 && day === 3) return "文化の日";
            if (month === 11 && day === 23) return "勤労感謝の日";

            // Happy Monday
            const isHappyMonday = (m, n) => {
                if (month !== m) return false;
                if (dayOfWeek !== 1) return false;
                const firstDayOfWeek = new Date(year, month - 1, 1).getDay();
                const firstMondayDate = firstDayOfWeek <= 1 ? 1 + (1 - firstDayOfWeek) : 1 + (8 - firstDayOfWeek);
                const targetDate = firstMondayDate + (n - 1) * 7;
                return day === targetDate;
            }

            if (isHappyMonday(1, 2)) return "成人の日";
            if (isHappyMonday(7, 3)) return "海の日";
            if (isHappyMonday(9, 3)) return "敬老の日";
            if (isHappyMonday(10, 2)) return "スポーツの日";

            // Equinoxes (Approximation)
            const vernal = Math.floor(20.8431 + 0.242194 * (year - 1980) - Math.floor((year - 1980) / 4));
            const autumnal = Math.floor(23.2488 + 0.242194 * (year - 1980) - Math.floor((year - 1980) / 4));
            if (month === 3 && day === vernal) return "春分の日";
            if (month === 9 && day === autumnal) return "秋分の日";

            return null;
        };

        const getHolidayName = (date) => {
            // Check Raw Holiday
            const rawName = getHolidayNameRaw(date);
            if (rawName) return rawName;

            // Substitute Holiday Check (Basic Rule: If yesterday was a Sunday Holiday)
            const yesterday = new Date(date);
            yesterday.setDate(date.getDate() - 1);
            if (yesterday.getDay() === 0) {
                const yName = getHolidayNameRaw(yesterday);
                if (yName) return `振替休日（${yName}）`;
            }

            // Golden Week Special (May 6)
            const month = date.getMonth() + 1;
            const day = date.getDate();
            if (month === 5 && day === 6) {
                const d3 = new Date(date.getFullYear(), 4, 3).getDay(); // May 3
                const d4 = new Date(date.getFullYear(), 4, 4).getDay(); // May 4
                if ((d3 === 0 || d4 === 0) && date.getDay() > 1) { 
                     return "振替休日";
                }
            }

            return null;
        };

        // Storage Wrapper
        const STORAGE_KEY = 'teacher_schedule_app_v4'; // Keep key
        
        const saveToStorage = (data) => {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            } catch (e) {
                console.error("Storage failed", e);
                alert("保存に失敗しました。容量がいっぱいの可能性があります。");
            }
        };

        const loadFromStorage = () => {
            try {
                let data = localStorage.getItem(STORAGE_KEY);
                if (data) return JSON.parse(data);

                const oldData = localStorage.getItem('teacher_schedule_app_v3');
                if (oldData) {
                    return JSON.parse(oldData);
                }
                return null;
            } catch (e) {
                console.error("Load failed", e);
                return null;
            }
        };

        // Initial Data
        const INITIAL_COURSES = [
            { id: 'c1', name: '国語総合', color: '#fed7aa' }, // Orange
            { id: 'c2', name: '現代文B', color: '#fbcfe8' }, // Pink
            { id: 'c3', name: '古典B', color: '#bae6fd' }, // Blue
            { id: 'c4', name: 'LHR', color: '#bbf7d0' }, // Green
            { id: 'c5', name: '会議', color: '#e5e7eb' }, // Gray
            { id: 'c6', name: '出張', color: '#fef08a' }, // Yellow
        ];

        const PRESET_COLORS = [
            '#fee2e2', '#ffedd5', '#fef9c3', '#dcfce7', '#dbeafe', '#e0e7ff', '#f3e8ff', '#fae8ff', '#f1f5f9', '#ffffff'
        ];

        // --- Components ---

        const Icon = ({ name, size = 20, className = "" }) => {
            return <i className={`ph ph-${name} ${className}`} style={{ fontSize: size }}></i>;
        };

        const Modal = ({ isOpen, onClose, title, children }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-4 transition-opacity">
                    <div className="bg-white rounded-xl shadow-xl w-full max-w-md overflow-hidden animate-fade-in-up">
                        <div className="flex justify-between items-center p-4 border-b bg-gray-50">
                            <h3 className="font-bold text-lg text-gray-800">{title}</h3>
                            <button onClick={onClose} className="p-2 rounded-full hover:bg-gray-200 text-gray-500">
                                <Icon name="x" size={24} />
                            </button>
                        </div>
                        <div className="p-4 max-h-[70vh] overflow-y-auto">
                            {children}
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [currentDate, setCurrentDate] = useState(getMonday(new Date()));
            const [courses, setCourses] = useState(INITIAL_COURSES);
            const [basicSchedule, setBasicSchedule] = useState({});
            const [weeklySchedules, setWeeklySchedules] = useState({});
            const [weeklyMemos, setWeeklyMemos] = useState({});
            
            const [statsRange, setStatsRange] = useState(() => {
                const today = new Date();
                const start = getMonday(today);
                const end = addDays(start, 5);
                return {
                    start: formatDateKey(start),
                    end: formatDateKey(end)
                };
            });

            const [activeTab, setActiveTab] = useState('schedule');
            const [isLoaded, setIsLoaded] = useState(false);
            const [toast, setToast] = useState(null);

            useEffect(() => {
                const data = loadFromStorage();
                if (data) {
                    setCourses(data.courses || INITIAL_COURSES);
                    setBasicSchedule(data.basicSchedule || {});
                    setWeeklySchedules(data.weeklySchedules || {});
                    if (data.weeklyMemos) {
                        setWeeklyMemos(data.weeklyMemos);
                    }
                    if (data.statsRange) {
                        setStatsRange(data.statsRange);
                    }
                }
                setIsLoaded(true);
            }, []);

            useEffect(() => {
                if (isLoaded) {
                    saveToStorage({ 
                        courses, 
                        basicSchedule, 
                        weeklySchedules, 
                        weeklyMemos,
                        statsRange 
                    });
                }
            }, [courses, basicSchedule, weeklySchedules, weeklyMemos, statsRange, isLoaded]);

            const showToast = (msg) => {
                setToast(msg);
                setTimeout(() => setToast(null), 3000);
            };

            const goToNextWeek = () => setCurrentDate(addDays(currentDate, 7));
            const goToPrevWeek = () => setCurrentDate(addDays(currentDate, -7));
            const goToThisWeek = () => setCurrentDate(getMonday(new Date()));
            
            const jumpToDate = (targetDate) => {
                setCurrentDate(getMonday(targetDate));
            };

            const currentMondayKey = formatDateKey(currentDate);
            const currentWeekData = weeklySchedules[currentMondayKey] || {};
            const currentWeekMemos = weeklyMemos[currentMondayKey] || {};

            const updateSchedule = (dayIndex, periodIndex, courseId) => {
                const key = `${dayIndex}-${periodIndex}`;
                const newSchedule = { ...weeklySchedules };
                if (!newSchedule[currentMondayKey]) newSchedule[currentMondayKey] = {};
                
                if (courseId === null) {
                    delete newSchedule[currentMondayKey][key];
                } else {
                    newSchedule[currentMondayKey][key] = courseId;
                }
                setWeeklySchedules(newSchedule);
            };

            const updateMemo = (dayIndex, periodIndex, text) => {
                const key = `${dayIndex}-${periodIndex}`;
                const newMemos = { ...weeklyMemos };
                if (!newMemos[currentMondayKey]) newMemos[currentMondayKey] = {};
                
                if (text === null || text.trim() === "") {
                    delete newMemos[currentMondayKey][key];
                } else {
                    newMemos[currentMondayKey][key] = text;
                }
                setWeeklyMemos(newMemos);
            };

            const copyPrevWeek = () => {
                const prevMonday = addDays(currentDate, -7);
                const prevKey = formatDateKey(prevMonday);
                if (weeklySchedules[prevKey]) {
                    if (confirm("先週の時間割を今週にコピーしますか？（現在の入力は上書きされます）")) {
                        const newSchedule = { ...weeklySchedules };
                        newSchedule[currentMondayKey] = {}; 
                        
                        let skippedHolidays = [];

                        [0, 1, 2, 3, 4, 5].forEach(dayIndex => {
                            const targetDate = addDays(currentDate, dayIndex);
                            const holidayName = getHolidayName(targetDate);

                            if (holidayName) {
                                skippedHolidays.push(`${daysMap[dayIndex]}曜: ${holidayName}`);
                            } else {
                                Object.keys(weeklySchedules[prevKey]).forEach(key => {
                                    if (key.startsWith(`${dayIndex}-`)) {
                                        newSchedule[currentMondayKey][key] = weeklySchedules[prevKey][key];
                                    }
                                });
                            }
                        });

                        setWeeklySchedules(newSchedule);
                        if (skippedHolidays.length > 0) {
                            showToast(`祝日(${skippedHolidays.length}日)を除外してコピーしました`);
                        } else {
                            showToast("先週の内容をコピーしました");
                        }
                    }
                } else {
                    alert("先週のデータがありません");
                }
            };

            const applyBasicSchedule = () => {
                if (confirm("基本時間割を今週に適用しますか？（現在の入力は上書きされます）")) {
                    const newSchedule = { ...weeklySchedules };
                    newSchedule[currentMondayKey] = {}; 

                    let skippedHolidays = [];

                    [0, 1, 2, 3, 4, 5].forEach(dayIndex => {
                        const targetDate = addDays(currentDate, dayIndex);
                        const holidayName = getHolidayName(targetDate);

                        if (holidayName) {
                            skippedHolidays.push(`${daysMap[dayIndex]}曜: ${holidayName}`);
                        } else {
                             Object.keys(basicSchedule).forEach(key => {
                                if (key.startsWith(`${dayIndex}-`)) {
                                    newSchedule[currentMondayKey][key] = basicSchedule[key];
                                }
                            });
                        }
                    });

                    setWeeklySchedules(newSchedule);
                    if (skippedHolidays.length > 0) {
                        showToast(`祝日(${skippedHolidays.length}日)を除外して適用しました`);
                    } else {
                        showToast("基本時間割を適用しました");
                    }
                }
            };

            const clearCurrentWeek = () => {
                if (confirm("今週のデータを全て空にしますか？")) {
                    const newSchedule = { ...weeklySchedules };
                    delete newSchedule[currentMondayKey];
                    setWeeklySchedules(newSchedule);
                    
                    const newMemos = { ...weeklyMemos };
                    delete newMemos[currentMondayKey];
                    setWeeklyMemos(newMemos);

                    showToast("今週のデータをクリアしました");
                }
            };

            const daysMap = ['月', '火', '水', '木', '金', '土'];

            const touchStartX = useRef(0);
            const handleTouchStart = (e) => touchStartX.current = e.touches[0].clientX;
            const handleTouchEnd = (e) => {
                const diff = touchStartX.current - e.changedTouches[0].clientX;
                if (Math.abs(diff) > 50) { 
                    if (diff > 0) goToNextWeek();
                    else goToPrevWeek();
                }
            };

            const handleImportData = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        if (data && data.courses && data.weeklySchedules) {
                            if(confirm("データを読み込みますか？現在のデータは上書きされます。")) {
                                setCourses(data.courses);
                                setBasicSchedule(data.basicSchedule || {});
                                setWeeklySchedules(data.weeklySchedules || {});
                                if (data.weeklyMemos) setWeeklyMemos(data.weeklyMemos);
                                if (data.statsRange) setStatsRange(data.statsRange);
                                showToast("データの復元が完了しました");
                            }
                        } else {
                            alert("無効なファイル形式です");
                        }
                    } catch (error) {
                        alert("読み込みエラーが発生しました");
                    }
                };
                reader.readAsText(file);
                e.target.value = '';
            };

            const renderContent = () => {
                switch (activeTab) {
                    case 'schedule':
                        return (
                            <ScheduleView 
                                date={currentDate}
                                scheduleData={currentWeekData}
                                memoData={currentWeekMemos}
                                courses={courses}
                                onUpdate={updateSchedule}
                                onUpdateMemo={updateMemo}
                                onPrev={goToPrevWeek}
                                onNext={goToNextWeek}
                                onToday={goToThisWeek}
                                onJumpToDate={jumpToDate}
                                onCopyPrev={copyPrevWeek}
                                onApplyBasic={applyBasicSchedule}
                                onClear={clearCurrentWeek}
                                touchHandlers={{ onTouchStart: handleTouchStart, onTouchEnd: handleTouchEnd }}
                            />
                        );
                    case 'basic':
                        return (
                            <BasicScheduleView 
                                scheduleData={basicSchedule}
                                courses={courses}
                                onUpdate={(d, p, c) => {
                                    const key = `${d}-${p}`;
                                    const newBasic = { ...basicSchedule };
                                    if(c === null) delete newBasic[key];
                                    else newBasic[key] = c;
                                    setBasicSchedule(newBasic);
                                }}
                            />
                        );
                    case 'courses':
                        return (
                            <CourseManager 
                                courses={courses} 
                                setCourses={setCourses} 
                            />
                        );
                    case 'stats':
                        return (
                            <StatsView 
                                weeklySchedules={weeklySchedules}
                                courses={courses}
                                basicSchedule={basicSchedule} 
                                weeklyMemos={weeklyMemos}
                                onImport={handleImportData}
                                statsRange={statsRange}
                                setStatsRange={setStatsRange}
                            />
                        );
                    default:
                        return null;
                }
            };

            if (!isLoaded) return <div className="flex h-screen items-center justify-center">読み込み中...</div>;

            return (
                <div className="flex flex-col h-screen max-w-md mx-auto bg-white shadow-2xl overflow-hidden sm:max-w-full md:max-w-3xl lg:max-w-4xl">
                    <main className="flex-1 overflow-hidden relative bg-gray-50 pt-safe-top">
                        {renderContent()}
                    </main>

                    <nav className="bg-white border-t border-gray-200 flex justify-around pb-safe">
                        <NavButton icon="calendar" label="週案" active={activeTab === 'schedule'} onClick={() => setActiveTab('schedule')} />
                        <NavButton icon="table" label="基本時間割" active={activeTab === 'basic'} onClick={() => setActiveTab('basic')} />
                        <NavButton icon="list-checks" label="講座管理" active={activeTab === 'courses'} onClick={() => setActiveTab('courses')} />
                        <NavButton icon="chart-bar" label="集計" active={activeTab === 'stats'} onClick={() => setActiveTab('stats')} />
                    </nav>

                    {toast && (
                        <div className="absolute bottom-20 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-full shadow-lg text-sm animate-bounce z-50">
                            {toast}
                        </div>
                    )}
                </div>
            );
        };

        const NavButton = ({ icon, label, active, onClick }) => (
            <button 
                onClick={onClick}
                className={`flex flex-col items-center justify-center w-full py-2 ${active ? 'text-indigo-600' : 'text-gray-400'}`}
            >
                <Icon name={icon} size={24} weight={active ? "fill" : "regular"} />
                <span className={`${label.length > 4 ? 'text-[9px]' : 'text-[10px]'} mt-1 font-medium`}>{label}</span>
            </button>
        );

        const ScheduleView = ({ date, scheduleData, memoData, courses, onUpdate, onUpdateMemo, onPrev, onNext, onToday, onJumpToDate, onCopyPrev, onApplyBasic, onClear, touchHandlers }) => {
            const days = ['月', '火', '水', '木', '金', '土'];
            const periods = [1, 2, 3, 4, 5, 6, 7];
            const [selectedCell, setSelectedCell] = useState(null);
            const datePickerRef = useRef(null);

            const getCourse = (day, period) => {
                const id = scheduleData[`${day}-${period}`];
                return courses.find(c => c.id === id);
            };

            const getMemo = (day, period) => {
                return memoData[`${day}-${period}`] || "";
            };

            const headerDates = useMemo(() => {
                const start = getMonday(date);
                return Array.from({ length: 6 }).map((_, i) => addDays(start, i));
            }, [date]);

            const isToday = (d) => {
                const today = new Date();
                return d.getDate() === today.getDate() && d.getMonth() === today.getMonth();
            };

            const holidayNames = useMemo(() => {
                return headerDates.map(d => getHolidayName(d));
            }, [headerDates]);

            return (
                <div className="h-full flex flex-col" {...touchHandlers}>
                    <div className="bg-white border-b p-2 flex items-center justify-between shadow-sm z-10">
                        <div className="flex items-center justify-between flex-1 max-w-[340px]">
                            <button onClick={onPrev} className="p-2 hover:bg-gray-100 rounded-full flex-shrink-0 text-gray-600"><Icon name="caret-left" size={24} /></button>
                            
                            {/* Update: Clickable Date Display with showPicker logic */}
                            <div 
                                className="text-center flex-1 mx-1 overflow-hidden relative group rounded hover:bg-gray-50 transition-colors cursor-pointer"
                                onClick={() => {
                                    if (datePickerRef.current) {
                                        try {
                                            // Modern standard
                                            if (typeof datePickerRef.current.showPicker === 'function') {
                                                datePickerRef.current.showPicker();
                                            } else {
                                                // Fallback
                                                datePickerRef.current.click();
                                            }
                                        } catch (e) {
                                            console.error("Picker error", e);
                                            // Last resort
                                            datePickerRef.current.click();
                                        }
                                    }
                                }}
                            >
                                {/* Visible Label */}
                                <div className="text-sm font-bold text-gray-800 whitespace-nowrap overflow-hidden text-ellipsis flex items-center justify-center gap-1 py-1">
                                    {getYearMonthString(date)} <Icon name="caret-down" size={12} className="text-gray-400" />
                                </div>
                                {/* Hidden but actionable Input */}
                                <input 
                                    type="date" 
                                    ref={datePickerRef}
                                    className="absolute top-0 left-0 w-0 h-0 opacity-0"
                                    tabIndex={-1}
                                    onChange={(e) => {
                                        if (e.target.value) {
                                            onJumpToDate(new Date(e.target.value));
                                            e.target.value = ''; // Reset to allow re-selection of same date
                                        }
                                    }}
                                />
                            </div>

                            <button onClick={onNext} className="p-2 hover:bg-gray-100 rounded-full flex-shrink-0 text-gray-600"><Icon name="caret-right" size={24} /></button>
                        </div>
                        <button onClick={onToday} className="px-3 py-1 text-xs bg-indigo-100 text-indigo-700 rounded-full font-bold flex-shrink-0 ml-2">今週</button>
                    </div>

                    <div className="flex gap-2 p-2 overflow-x-auto whitespace-nowrap bg-gray-50 border-b no-scrollbar">
                        <ActionButton icon="copy" label="前週コピー" onClick={onCopyPrev} />
                        <ActionButton icon="arrow-square-in" label="基本時間割適用" onClick={onApplyBasic} />
                        <ActionButton icon="trash" label="今週クリア" onClick={onClear} />
                    </div>

                    <div className="flex-1 overflow-auto bg-white relative">
                        <div className="timetable-grid min-w-[420px]">
                            <div className="timetable-header border-b border-r bg-gray-100"></div>
                            {days.map((day, i) => (
                                <div key={day} className={`timetable-header border-b ${isToday(headerDates[i]) ? 'bg-indigo-50 text-indigo-700' : ''}`}>
                                    <div className="flex flex-col items-center justify-center h-full py-1 relative w-full">
                                        {holidayNames[i] && (
                                            <div className="absolute top-0 right-0 p-0.5">
                                                <div className="w-2 h-2 rounded-full bg-red-400" title={holidayNames[i]}></div>
                                            </div>
                                        )}
                                        <span className={`text-xs font-bold leading-none mb-1 ${holidayNames[i] ? 'text-red-500' : ''}`}>{formatDateMMDD(headerDates[i])}</span>
                                        <span className={`text-sm leading-none ${holidayNames[i] ? 'text-red-500' : ''}`}>{day}</span>
                                    </div>
                                </div>
                            ))}

                            {periods.map(period => (
                                <React.Fragment key={period}>
                                    <div className="period-header border-r">{period}</div>
                                    {days.map((_, dayIndex) => {
                                        const course = getCourse(dayIndex, period);
                                        const memo = getMemo(dayIndex, period);
                                        const isHol = !!holidayNames[dayIndex];
                                        return (
                                            <div 
                                                key={`${dayIndex}-${period}`} 
                                                className="timetable-cell"
                                                style={{ backgroundColor: isHol ? '#fff5f5' : (course ? course.color : 'white') }}
                                                onClick={() => setSelectedCell({ 
                                                    dayIndex, 
                                                    period, 
                                                    currentCourseId: course?.id,
                                                    initialMemo: memo 
                                                })}
                                            >
                                                {course ? (
                                                    <span className="font-semibold text-gray-800 leading-tight break-words w-full px-1">
                                                        {course.name}
                                                    </span>
                                                ) : (
                                                    <span className="text-gray-300 text-xs">-</span>
                                                )}
                                                {memo && (
                                                    <span className="block mt-1 text-[9px] text-gray-600 bg-white/50 w-full truncate px-1 rounded">
                                                        <Icon name="note-pencil" size={10} className="inline mr-0.5" />{memo}
                                                    </span>
                                                )}
                                            </div>
                                        );
                                    })}
                                </React.Fragment>
                            ))}
                        </div>
                    </div>

                    <Modal 
                        isOpen={!!selectedCell} 
                        onClose={() => setSelectedCell(null)} 
                        title={`${days[selectedCell?.dayIndex]}曜 ${selectedCell?.period}限 選択`}
                    >
                        <div className="space-y-4">
                            <div className="bg-yellow-50 p-3 rounded-lg border border-yellow-100">
                                <label className="block text-xs font-bold text-yellow-800 mb-1 flex items-center gap-1">
                                    <Icon name="note-pencil" /> 授業メモ（テスト返却など）
                                </label>
                                <textarea
                                    className="w-full p-2 text-sm border rounded focus:ring-2 focus:ring-indigo-500 outline-none"
                                    rows="2"
                                    placeholder="ここに入力すると自動保存されます"
                                    defaultValue={selectedCell?.initialMemo || ""}
                                    onChange={(e) => onUpdateMemo(selectedCell.dayIndex, selectedCell.period, e.target.value)}
                                ></textarea>
                            </div>

                            <div className="grid grid-cols-2 gap-2">
                                <button 
                                    onClick={() => { onUpdate(selectedCell.dayIndex, selectedCell.period, null); setSelectedCell(null); }}
                                    className="col-span-2 p-3 border-2 border-dashed border-gray-300 rounded-lg text-gray-500 hover:bg-gray-50 flex items-center justify-center gap-2"
                                >
                                    <Icon name="eraser" /> 空きコマにする
                                </button>
                                {courses.map(course => (
                                    <button
                                        key={course.id}
                                        onClick={() => { onUpdate(selectedCell.dayIndex, selectedCell.period, course.id); setSelectedCell(null); }}
                                        className="p-3 rounded-lg text-sm font-bold shadow-sm text-gray-800 border transition-transform active:scale-95"
                                        style={{ backgroundColor: course.color, borderColor: 'rgba(0,0,0,0.05)' }}
                                    >
                                        {course.name}
                                    </button>
                                ))}
                            </div>
                        </div>
                    </Modal>
                </div>
            );
        };

        const ActionButton = ({ icon, label, onClick }) => (
            <button onClick={onClick} className="flex items-center gap-1 px-3 py-1.5 bg-white border border-gray-300 rounded text-xs font-medium text-gray-700 shadow-sm active:bg-gray-100">
                <Icon name={icon} size={14} /> {label}
            </button>
        );

        const BasicScheduleView = ({ scheduleData, courses, onUpdate }) => {
            const days = ['月', '火', '水', '木', '金', '土'];
            const periods = [1, 2, 3, 4, 5, 6, 7];
            const [selectedCell, setSelectedCell] = useState(null);

            const getCourse = (day, period) => {
                const id = scheduleData[`${day}-${period}`];
                return courses.find(c => c.id === id);
            };

            return (
                <div className="h-full flex flex-col">
                    <div className="p-4 bg-yellow-50 border-b border-yellow-100 shadow-sm">
                        <h2 className="text-sm font-bold text-yellow-800 flex items-center gap-2">
                            <Icon name="info" /> 基本時間割の設定
                        </h2>
                        <p className="text-xs text-yellow-700 mt-1">ここで設定したパターンは、週案画面の「基本時間割適用」ボタンで呼び出せます。</p>
                    </div>
                    
                    <div className="flex-1 overflow-auto bg-white pb-20">
                        <div className="timetable-grid min-w-[420px]">
                            <div className="timetable-header border-b border-r bg-gray-100"></div>
                            {days.map(day => (
                                <div key={day} className="timetable-header border-b bg-gray-50">
                                    {day}
                                </div>
                            ))}
                            {periods.map(period => (
                                <React.Fragment key={period}>
                                    <div className="period-header border-r">{period}</div>
                                    {days.map((_, dayIndex) => {
                                        const course = getCourse(dayIndex, period);
                                        return (
                                            <div 
                                                key={`${dayIndex}-${period}`} 
                                                className="timetable-cell"
                                                style={{ backgroundColor: course ? course.color : 'white' }}
                                                onClick={() => setSelectedCell({ dayIndex, period })}
                                            >
                                                {course ? (
                                                    <span className="font-semibold text-gray-800">{course.name}</span>
                                                ) : (
                                                    <span className="text-gray-300 text-xs">-</span>
                                                )}
                                            </div>
                                        );
                                    })}
                                </React.Fragment>
                            ))}
                        </div>
                    </div>
                     <Modal 
                        isOpen={!!selectedCell} 
                        onClose={() => setSelectedCell(null)} 
                        title={`${days[selectedCell?.dayIndex]}曜 ${selectedCell?.period}限 (基本時間割)`}
                    >
                         <div className="grid grid-cols-2 gap-2">
                            <button 
                                onClick={() => { onUpdate(selectedCell.dayIndex, selectedCell.period, null); setSelectedCell(null); }}
                                className="col-span-2 p-3 border-2 border-dashed border-gray-300 rounded-lg text-gray-500 hover:bg-gray-50 flex items-center justify-center gap-2"
                            >
                                <Icon name="eraser" /> 設定なし
                            </button>
                            {courses.map(course => (
                                <button
                                    key={course.id}
                                    onClick={() => { onUpdate(selectedCell.dayIndex, selectedCell.period, course.id); setSelectedCell(null); }}
                                    className="p-3 rounded-lg text-sm font-bold shadow-sm text-gray-800 border"
                                    style={{ backgroundColor: course.color }}
                                >
                                    {course.name}
                                </button>
                            ))}
                        </div>
                    </Modal>
                </div>
            );
        };

        const CourseManager = ({ courses, setCourses }) => {
            const [isEditing, setIsEditing] = useState(null);
            const [editName, setEditName] = useState("");
            const [editColor, setEditColor] = useState(PRESET_COLORS[0]);

            const handleSave = () => {
                if (!editName.trim()) return;
                
                if (isEditing === 'NEW') {
                    const newCourse = {
                        id: 'c' + Date.now(),
                        name: editName,
                        color: editColor
                    };
                    setCourses([...courses, newCourse]);
                } else {
                    setCourses(courses.map(c => c.id === isEditing ? { ...c, name: editName, color: editColor } : c));
                }
                setIsEditing(null);
                setEditName("");
            };

            const handleDelete = (id) => {
                if (confirm("この講座を削除しますか？\n（すでに登録された時間割には影響しません）")) {
                    setCourses(courses.filter(c => c.id !== id));
                }
            };

            const moveCourse = (index, direction) => {
                const newCourses = [...courses];
                if (direction === 'up' && index > 0) {
                    [newCourses[index], newCourses[index - 1]] = [newCourses[index - 1], newCourses[index]];
                } else if (direction === 'down' && index < newCourses.length - 1) {
                    [newCourses[index], newCourses[index + 1]] = [newCourses[index + 1], newCourses[index]];
                }
                setCourses(newCourses);
            };

            const openEdit = (course) => {
                setIsEditing(course.id);
                setEditName(course.name);
                setEditColor(course.color);
            };

            const openNew = () => {
                setIsEditing('NEW');
                setEditName("");
                setEditColor(PRESET_COLORS[1]);
            };

            return (
                <div className="h-full flex flex-col bg-gray-50">
                    <div className="p-4 bg-white border-b shadow-sm sticky top-0 z-10 flex justify-between items-center">
                        <h2 className="text-lg font-bold text-gray-800">登録済み講座一覧</h2>
                        <button onClick={openNew} className="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-bold shadow hover:bg-indigo-700 flex items-center gap-2">
                            <Icon name="plus" weight="bold" /> 新規追加
                        </button>
                    </div>

                    <div className="p-4 space-y-3 overflow-y-auto pb-20">
                        {courses.map((course, index) => (
                            <div key={course.id} className="bg-white p-3 rounded-xl shadow-sm border flex items-center justify-between">
                                <div className="flex items-center gap-3">
                                    <div className="flex flex-col gap-1 mr-1">
                                        <button 
                                            onClick={() => moveCourse(index, 'up')} 
                                            disabled={index === 0}
                                            className={`p-1 rounded hover:bg-gray-100 ${index === 0 ? 'text-gray-200' : 'text-gray-500'}`}
                                        >
                                            <Icon name="caret-up" size={16} />
                                        </button>
                                        <button 
                                            onClick={() => moveCourse(index, 'down')} 
                                            disabled={index === courses.length - 1}
                                            className={`p-1 rounded hover:bg-gray-100 ${index === courses.length - 1 ? 'text-gray-200' : 'text-gray-500'}`}
                                        >
                                            <Icon name="caret-down" size={16} />
                                        </button>
                                    </div>
                                    <div className="w-10 h-10 rounded-full border shadow-inner" style={{ backgroundColor: course.color }}></div>
                                    <span className="font-bold text-gray-800 text-lg">{course.name}</span>
                                </div>
                                <div className="flex gap-2">
                                    <button onClick={() => openEdit(course)} className="p-2 text-indigo-600 hover:bg-indigo-50 rounded"><Icon name="pencil-simple" size={20} /></button>
                                    <button onClick={() => handleDelete(course.id)} className="p-2 text-red-500 hover:bg-red-50 rounded"><Icon name="trash" size={20} /></button>
                                </div>
                            </div>
                        ))}
                    </div>

                    <Modal 
                        isOpen={!!isEditing} 
                        onClose={() => setIsEditing(null)} 
                        title={isEditing === 'NEW' ? "講座の新規登録" : "講座の編集"}
                    >
                        <div className="space-y-4">
                            <div>
                                <label className="block text-sm font-bold text-gray-700 mb-1">講座名（科目名・クラス）</label>
                                <input 
                                    type="text" 
                                    className="w-full p-3 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none text-lg"
                                    placeholder="例：数学Ⅰ A組"
                                    value={editName}
                                    onChange={(e) => setEditName(e.target.value)}
                                    autoFocus
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-bold text-gray-700 mb-2">表示色</label>
                                <div className="grid grid-cols-5 gap-3">
                                    {PRESET_COLORS.map(color => (
                                        <button
                                            key={color}
                                            onClick={() => setEditColor(color)}
                                            className={`w-10 h-10 rounded-full border-2 shadow-sm ${editColor === color ? 'border-indigo-600 scale-110 ring-2 ring-indigo-200' : 'border-transparent'}`}
                                            style={{ backgroundColor: color }}
                                        />
                                    ))}
                                    <div className="relative w-10 h-10 rounded-full overflow-hidden border-2 border-gray-200">
                                        <input 
                                            type="color" 
                                            value={editColor} 
                                            onChange={(e) => setEditColor(e.target.value)}
                                            className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-[150%] h-[150%] p-0 border-0 cursor-pointer"
                                        />
                                    </div>
                                </div>
                            </div>
                            <div className="pt-4 flex gap-3">
                                <button onClick={() => setIsEditing(null)} className="flex-1 py-3 bg-gray-100 text-gray-700 rounded-lg font-bold">キャンセル</button>
                                <button onClick={handleSave} className="flex-1 py-3 bg-indigo-600 text-white rounded-lg font-bold shadow hover:bg-indigo-700">保存する</button>
                            </div>
                        </div>
                    </Modal>
                </div>
            );
        };

        const StatsView = ({ weeklySchedules, courses, basicSchedule, weeklyMemos, onImport, statsRange, setStatsRange }) => {
            const today = new Date();
            const startDate = statsRange.start;
            const endDate = statsRange.end;

            const fileInputRef = useRef(null);

            const stats = useMemo(() => {
                const counts = {};
                const dates = {}; 
                courses.forEach(c => {
                    counts[c.id] = 0;
                    dates[c.id] = [];
                });
                let total = 0;

                const start = new Date(startDate);
                const end = new Date(endDate);

                Object.keys(weeklySchedules).forEach(mondayKey => {
                    const mondayDate = new Date(mondayKey);
                    const weekData = weeklySchedules[mondayKey];
                    
                    [0, 1, 2, 3, 4, 5].forEach(dayIndex => {
                        const currentDay = addDays(mondayDate, dayIndex);
                        const currentDayStr = formatDateKey(currentDay);
                        
                        if (currentDayStr >= startDate && currentDayStr <= endDate) {
                            [1, 2, 3, 4, 5, 6, 7].forEach(period => {
                                const courseId = weekData[`${dayIndex}-${period}`];
                                if (courseId && counts[courseId] !== undefined) {
                                    counts[courseId]++;
                                    dates[courseId].push(formatDateMMDD(currentDay));
                                    total++;
                                }
                            });
                        }
                    });
                });
                
                Object.keys(dates).forEach(cId => {
                    dates[cId].sort(); 
                });

                return { counts, dates, total };
            }, [weeklySchedules, courses, startDate, endDate]);

            const copyStats = () => {
                let text = `【授業時数集計】\n期間：${startDate} 〜 ${endDate}\n\n`;
                courses.forEach(c => {
                    if (stats.counts[c.id] > 0) {
                        text += `${c.name}: ${stats.counts[c.id]}コマ (${stats.dates[c.id].join(', ')})\n`;
                    }
                });
                text += `\n合計: ${stats.total}コマ`;
                
                navigator.clipboard.writeText(text).then(() => alert("クリップボードにコピーしました"));
            };

            const exportData = () => {
                const data = {
                    courses: courses,
                    basicSchedule: basicSchedule,
                    weeklySchedules: weeklySchedules,
                    weeklyMemos: weeklyMemos,
                    statsRange: statsRange,
                    version: 'v4',
                    exportDate: new Date().toISOString()
                };
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `teacher_schedule_backup_${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            };

            const setRange = (type) => {
                const now = new Date();
                const m = getMonday(now);
                if (type === 'week') {
                    setStatsRange({
                        start: formatDateKey(m),
                        end: formatDateKey(addDays(m, 5))
                    });
                } else if (type === 'month') {
                    const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
                    const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                    setStatsRange({
                        start: formatDateKey(firstDay),
                        end: formatDateKey(lastDay)
                    });
                }
            };

            return (
                <div className="h-full flex flex-col bg-white p-4 overflow-y-auto pb-20">
                    <h2 className="text-lg font-bold mb-4 flex items-center gap-2"><Icon name="chart-pie-slice" /> 時数集計</h2>
                    
                    <div className="bg-gray-50 p-4 rounded-xl border mb-6">
                        <div className="flex gap-2 mb-4">
                            <button onClick={() => setRange('week')} className="flex-1 py-1 text-xs bg-white border rounded shadow-sm">今週</button>
                            <button onClick={() => setRange('month')} className="flex-1 py-1 text-xs bg-white border rounded shadow-sm">今月</button>
                        </div>
                        <div className="flex items-center gap-2 justify-between mb-2">
                            <input 
                                type="date" 
                                value={startDate} 
                                onChange={e => setStatsRange({...statsRange, start: e.target.value})} 
                                className="border p-1 rounded text-sm w-[45%]" 
                            />
                            <span className="text-gray-400">~</span>
                            <input 
                                type="date" 
                                value={endDate} 
                                onChange={e => setStatsRange({...statsRange, end: e.target.value})} 
                                className="border p-1 rounded text-sm w-[45%]" 
                            />
                        </div>
                    </div>

                    <div className="mb-2 border-b pb-2">
                         <span className="text-sm font-bold text-gray-600">集計結果</span>
                    </div>

                    <div className="space-y-4">
                        {courses
                            .filter(c => stats.counts[c.id] > 0)
                            .sort((a, b) => stats.counts[b.id] - stats.counts[a.id])
                            .map(c => (
                            <div key={c.id} className="flex items-start gap-3 border-b pb-3 last:border-0">
                                <div className="w-3 h-10 rounded-full flex-shrink-0 mt-1" style={{ backgroundColor: c.color }}></div>
                                <div className="flex-1">
                                    <div className="flex justify-between items-baseline mb-1">
                                        <span className="font-bold text-gray-800">{c.name}</span>
                                        <span className="font-bold text-lg">{stats.counts[c.id]}<span className="text-xs font-normal text-gray-500 ml-1">コマ</span></span>
                                    </div>
                                    <div className="text-[10px] text-gray-500 leading-tight">
                                        {stats.dates[c.id].join(', ')}
                                    </div>
                                </div>
                            </div>
                        ))}
                        {stats.total === 0 && <div className="text-center text-gray-400 py-10">期間内の授業データがありません</div>}
                    </div>

                    <button onClick={copyStats} className="mt-8 w-full py-3 bg-gray-800 text-white rounded-lg font-bold flex items-center justify-center gap-2 shadow hover:bg-gray-700">
                        <Icon name="copy" /> 結果をコピー
                    </button>
                    
                    <div className="mt-8 pt-8 border-t">
                        <h3 className="text-xs font-bold text-gray-400 mb-4">データ管理</h3>
                        
                        <div className="grid grid-cols-2 gap-3 mb-6">
                            <button 
                                onClick={exportData}
                                className="flex items-center justify-center gap-2 py-2 px-4 bg-green-600 text-white rounded-lg font-bold text-sm shadow hover:bg-green-700"
                            >
                                <Icon name="download-simple" /> エクスポート
                            </button>
                            <button 
                                onClick={() => fileInputRef.current.click()}
                                className="flex items-center justify-center gap-2 py-2 px-4 bg-blue-600 text-white rounded-lg font-bold text-sm shadow hover:bg-blue-700"
                            >
                                <Icon name="upload-simple" /> インポート
                            </button>
                            <input 
                                type="file" 
                                ref={fileInputRef} 
                                className="hidden" 
                                accept=".json" 
                                onChange={onImport}
                            />
                        </div>

                        <button 
                            onClick={() => {
                                if(confirm('本当に全てのデータを削除しますか？復元できません。')) {
                                    localStorage.removeItem(STORAGE_KEY);
                                    window.location.reload();
                                }
                            }}
                            className="text-red-500 text-xs underline block w-full text-center"
                        >
                            全てのデータをリセット（初期化）
                        </button>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>