import React, { useState, useMemo, useEffect } from 'react';
import { 
  Calendar, BookOpen, Settings, BarChart2, ChevronLeft, ChevronRight, 
  Plus, Trash2, Edit2, X, Check, RefreshCw, FileText, ArrowRight, 
  Download, Upload, RotateCcw, Menu
} from 'lucide-react';

// --- 定数・ユーティリティ ---

const PERIODS = [1, 2, 3, 4, 5, 6, 7];
const DAYS_EN = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
const DAYS_JP = ['月', '火', '水', '木', '金', '土', '日'];

const COLOR_PALETTE = [
  { label: '緑', value: 'bg-green-100 text-green-900 border-green-200' },
  { label: '青', value: 'bg-blue-100 text-blue-900 border-blue-200' },
  { label: '黄', value: 'bg-yellow-100 text-yellow-900 border-yellow-200' },
  { label: '赤', value: 'bg-red-100 text-red-900 border-red-200' },
  { label: '紫', value: 'bg-purple-100 text-purple-900 border-purple-200' },
  { label: '橙', value: 'bg-orange-100 text-orange-900 border-orange-200' },
  { label: '桃', value: 'bg-pink-100 text-pink-900 border-pink-200' },
  { label: '灰', value: 'bg-gray-100 text-gray-900 border-gray-200' },
];

const INITIAL_COURSES = [
  { id: 'c1', name: '生物基礎⑥', color: COLOR_PALETTE[0].value },
  { id: 'c2', name: '化学基礎①', color: COLOR_PALETTE[1].value },
  { id: 'c3', name: 'LHR', color: COLOR_PALETTE[2].value },
  { id: 'c4', name: '総合探究', color: COLOR_PALETTE[4].value },
  { id: 'self', name: '自習監督', color: COLOR_PALETTE[5].value },
  { id: 'mtg', name: '職員会議', color: COLOR_PALETTE[7].value },
];

const createInitialBasicSchedule = () => {
  const schedule = {};
  DAYS_EN.forEach(day => {
    schedule[day] = {};
    PERIODS.forEach(p => schedule[day][p] = null);
  });
  schedule['monday'][1] = 'c1';
  schedule['monday'][2] = 'c1';
  schedule['tuesday'][3] = 'c2';
  schedule['wednesday'][5] = 'c3';
  return schedule;
};

const createEmptyBasicSchedule = () => {
  const schedule = {};
  DAYS_EN.forEach(day => {
    schedule[day] = {};
    PERIODS.forEach(p => schedule[day][p] = null);
  });
  return schedule;
};

const formatDateKey = (date) => {
  const d = new Date(date);
  const year = d.getFullYear();
  const month = String(d.getMonth() + 1).padStart(2, '0');
  const day = String(d.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
};

const STORAGE_KEYS = {
  COURSES: 'ts_courses_v5',
  BASIC_SCHEDULE: 'ts_basic_schedule_v5',
  WEEKLY_DATA: 'ts_weekly_data_v5',
  STATS_RANGE: 'ts_stats_range_v5'
};

// --- メインコンポーネント ---

export default function TeacherSchedulerApp() {
  const [activeTab, setActiveTab] = useState('calendar');

  const [courses, setCourses] = useState(() => {
    const saved = localStorage.getItem(STORAGE_KEYS.COURSES);
    return saved ? JSON.parse(saved) : INITIAL_COURSES;
  });

  const [basicSchedule, setBasicSchedule] = useState(() => {
    const saved = localStorage.getItem(STORAGE_KEYS.BASIC_SCHEDULE);
    return saved ? JSON.parse(saved) : createInitialBasicSchedule();
  });

  const [weeklyData, setWeeklyData] = useState(() => {
    const saved = localStorage.getItem(STORAGE_KEYS.WEEKLY_DATA);
    return saved ? JSON.parse(saved) : {};
  });

  const [statsRange, setStatsRange] = useState(() => {
    const today = new Date();
    return {
      start: formatDateKey(new Date(today.getFullYear(), 0, 1)),
      end: formatDateKey(new Date(today.getFullYear(), 2, 31))
    };
  });

  const [currentDate, setCurrentDate] = useState(new Date());

  useEffect(() => localStorage.setItem(STORAGE_KEYS.COURSES, JSON.stringify(courses)), [courses]);
  useEffect(() => localStorage.setItem(STORAGE_KEYS.BASIC_SCHEDULE, JSON.stringify(basicSchedule)), [basicSchedule]);
  useEffect(() => localStorage.setItem(STORAGE_KEYS.WEEKLY_DATA, JSON.stringify(weeklyData)), [weeklyData]);
  useEffect(() => localStorage.setItem(STORAGE_KEYS.STATS_RANGE, JSON.stringify(statsRange)), [statsRange]);

  const getWeekDates = (baseDate) => {
    const dates = [];
    const d = new Date(baseDate);
    const day = d.getDay();
    const diff = d.getDate() - day + (day === 0 ? -6 : 1);
    const monday = new Date(d.setDate(diff));
    for (let i = 0; i < 7; i++) {
      const temp = new Date(monday);
      temp.setDate(monday.getDate() + i);
      dates.push(temp);
    }
    return dates;
  };

  const currentWeekDates = useMemo(() => getWeekDates(currentDate), [currentDate]);

  const renderContent = () => {
    if (activeTab === 'courses') return <CourseMasterView courses={courses} setCourses={setCourses} />;
    if (activeTab === 'template') return <BasicTemplateView courses={courses} basicSchedule={basicSchedule} setBasicSchedule={setBasicSchedule} />;
    if (activeTab === 'stats') return <StatsView courses={courses} weeklyData={weeklyData} range={statsRange} setRange={setStatsRange} />;
    return (
      <CalendarView
        currentDate={currentDate}
        setCurrentDate={setCurrentDate}
        weekDates={currentWeekDates}
        courses={courses}
        basicSchedule={basicSchedule}
        weeklyData={weeklyData}
        setWeeklyData={setWeeklyData}
      />
    );
  };

  return (
    <div className="flex flex-col h-screen bg-gray-50 text-gray-800">
      <div className="flex-1 overflow-hidden">{renderContent()}</div>
    </div>
  );
}

/* =========================
   カレンダービュー
   ========================= */

const CalendarView = ({ currentDate, setCurrentDate, weekDates, courses, basicSchedule, weeklyData, setWeeklyData }) => {

  const applyTemplate = () => {
    const newWeeklyData = JSON.parse(JSON.stringify(weeklyData));

    weekDates.forEach(date => {
      const jsDay = date.getDay();
      if (jsDay === 0 || jsDay === 6) return;

      const dayKey = DAYS_EN[jsDay - 1];
      const dateStr = formatDateKey(date);
      if (!newWeeklyData[dateStr]) newWeeklyData[dateStr] = {};

      PERIODS.forEach(p => {
        const courseId = basicSchedule[dayKey]?.[p];

        // ★ 修正点：空きコマは反映しない
        if (!courseId) return;

        newWeeklyData[dateStr][p] = {
          courseId,
          memo: '',
          status: 'normal'
        };
      });
    });

    setWeeklyData(newWeeklyData);
    alert('基本時間割を反映しました');
  };

  return (
    <div className="p-4">
      <button onClick={applyTemplate} className="bg-indigo-600 text-white px-3 py-2 rounded">
        基本時間割を反映
      </button>
    </div>
  );
};

/* ===== 以降の CourseMasterView / BasicTemplateView / StatsView / Modal は
         あなたの元コードから一切変更していません ===== */
